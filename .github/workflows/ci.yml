name: CI - Tests AutomÃ¡ticos

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ==========================================
  # Tests del Backend
  # ==========================================
  test-backend:
    name: ğŸ§ª Tests Backend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./API_peliculas_IUDigital-main
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          cache-dependency-path: './API_peliculas_IUDigital-main/pnpm-lock.yaml'
      
      - name: ğŸ“¦ Instalar pnpm
        run: npm install -g pnpm
      
      - name: ğŸ“¦ Instalar dependencias
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ§ª Ejecutar tests
        run: pnpm test
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/test_db
      
      - name: âœ… Tests completados
        if: success()
        run: echo "âœ… Todos los tests del backend pasaron exitosamente"
      
      - name: âŒ Tests fallidos
        if: failure()
        run: echo "âŒ Algunos tests del backend fallaron"

  # ==========================================
  # Tests del Frontend
  # ==========================================
  test-frontend:
    name: ğŸ§ª Tests Frontend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: ğŸ“¦ Instalar dependencias
        run: npm ci
      
      - name: ğŸ§ª Ejecutar tests
        run: npm test -- --passWithNoTests --watchAll=false
        env:
          CI: true
          REACT_APP_API_URL: http://localhost:3001/api/v1
      
      - name: âœ… Tests completados
        if: success()
        run: echo "âœ… Todos los tests del frontend pasaron exitosamente"
      
      - name: âŒ Tests fallidos
        if: failure()
        run: echo "âŒ Algunos tests del frontend fallaron"

  # ==========================================
  # Lint (opcional pero recomendado)
  # ==========================================
  lint-backend:
    name: ğŸ“ Lint Backend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./API_peliculas_IUDigital-main
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Instalar pnpm
        run: npm install -g pnpm
      
      - name: ğŸ“¦ Instalar dependencias
        run: pnpm install --frozen-lockfile
      
      - name: ğŸ“ Ejecutar linter
        run: pnpm lint || echo "âš ï¸  Lint warnings encontradas (no bloquea pipeline)"
        continue-on-error: true

  # ==========================================
  # Resumen de CI
  # ==========================================
  ci-summary:
    name: ğŸ“Š Resumen CI
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, lint-backend]
    if: always()
    
    steps:
      - name: ğŸ“Š Estado del pipeline
        run: |
          echo "ğŸ” Resumen de IntegraciÃ³n Continua"
          echo "=================================="
          echo "Backend Tests: ${{ needs.test-backend.result }}"
          echo "Frontend Tests: ${{ needs.test-frontend.result }}"
          echo "Backend Lint: ${{ needs.lint-backend.result }}"
          
          if [[ "${{ needs.test-backend.result }}" == "success" ]] && \
             [[ "${{ needs.test-frontend.result }}" == "success" ]]; then
            echo "âœ… Pipeline CI completado exitosamente"
            exit 0
          else
            echo "âŒ Pipeline CI fallÃ³"
            exit 1
          fi
